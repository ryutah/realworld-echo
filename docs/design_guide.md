# Design Guide

各種設計に関する基本方針

## 命名規則

- ディレクトリ名
  - `-` 区切りにする
- ファイル名
  - 言語等にデファクトがなければ `_` 区切りにする
- テーブル名
  - 単数形で

## バックエンド実装

### エラー生成

`"github.com/cockroachdb/errors"` パッケージを利用して、トレース情報と詳細メッセージを追加する [MSUT]

## API

### リクエスト

#### 日付、時間

##### フォーマット

日付や時間は次の形式で扱う [MUST]

| タイプ       | フォーマット | 型     | 例                        |
| ------------ | ------------ | ------ | ------------------------- |
| 時間付き日付 | iso8601      | string | 2023-06-03T14:41:01+09:00 |
| 時間なし日付 | iso8601      | string | 2023-06-03                |
| 時間のみ     | HH:mm:ss     | string | 14:41:01                  |

#### 文字列

##### 最大文字数

クライアントが自由に入力できるフィールドには必ず最大文字数を設けること [MUST]

システム要件で特に指定のない場合は次の方針に従う [SHOULD]

| フィールドタイプ | 最大文字数 |
| ---------------- | ---------- |
| 短い文字列       | 256        |
| 長い文字列       | 1024       |
| とても長い文字列 | 1024       |
| email            | 256        |
| url              | 2048       |
| file path        | 256        |

---

### レスポンス

#### ステータスコード

[HTTP レスポンスステータスコード]を参考に、発生したエラーに応じて適切なものを付与する [MUST]

| ステータスコード範囲 | 用途                     |
| -------------------- | ------------------------ |
| 100 – 199            | 情報レスポンス           |
| 200 - 299            | 成功レスポンス           |
| 300 – 399            | リダイレクトメッセージ   |
| 400 – 499            | クライアントサイドエラー |
| 500 – 599            | サーバサイドエラー       |

#### エラー

クライアントサイドエラーが発生した場合は、発生した問題の詳細と解決方法をエラーメッセージに含める [SHOULD]

特に指定のない場合、エラーレスポンスは次のフォーマットにする [SHOULD]

```json
{
  "error": {
    "message": "[ERROR_SUMMARY_MESSAGE]"
    "errors": [
      {
        "message": "[ERROR_DETAILS]",
        "reason": "badRequest"
      }
    ],
  }
}
```

#### ページネーション

データ量が不確定な一覧を返す API は全データをまとめて返さずに、ページネーションを考慮した設計がされていること [MSUT]

## データベース

### PostgreSQL

#### ID 生成

- UUID v4 を利用する
- アプリケーションロジックで生成
- デフォルト値を設定する

```sql
id UUID NOT NULL PRIMARY KEY DEFAULT gen_random_uuid()
```

#### メタデータカラム

| column     | explain        | dsl                                                       |
| ---------- | -------------- | --------------------------------------------------------- |
| created_at | データ作成日時 | created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP |
| updated_at | データ更新日時 | updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP |

- 基本的には、アプリケーション側で指定を行う
  - `updated_at` は特に更新は自動で行われないため、アプリケーションロジックで必ず設定

#### Example

```sql
CREATE TABLE users (
  id UUID NOT NULL PRIMARY KEY DEFAULT gen_random_uuid(),
  name name NOT NULL,
  birthday DATE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ NOT NULl DEFAULT CURRENT_TIMESTAMP
);
```

#### 外部キー制約

- 外部キー制約をつける場合、 JOIN 等を行うことを意図しているカラムであるならば必ず INDEX も併せて追加すること

```sql
ALTER TABLE "playlist" ADD FOREIGN KEY ("user_id") REFERENCES "user"("id") ON DELETE CASCADE;
CREATE INDEX user_id_fk_index ON "playlist" USING btree ("user_id");
```

## ログ

### 出力するログ

次のログを必ず出力する

| log                              | level | reason                                             | output                             |
| -------------------------------- | ----- | -------------------------------------------------- | ---------------------------------- |
| アクセスログ                     | info  |                                                    |                                    |
| アプリケーションロジック開始ログ | info  | 実際に実行された処理がトレースできるようにするため | start [proc_name] with [arguments] |
| データ I/O ログ                  | info  |                                                    |                                    |
| エラーログ                       | error |                                                    |                                    |
| エラートレースログ               | error |                                                    |                                    |

### その他、あるとよいログ

| log        | level | reason                                             | output |
| ---------- | ----- | -------------------------------------------------- | ------ |
| 処理コール | debug | 実際に実行された処理がトレースできるようにするため |        |

> **Note**
>
> ### Appendix 良いログを書く
>
> 5W1H を意識することで、トレーサビリティが上がる。
> どのようなログを出力すればいいか悩んだときは、次のような情報が出力されているかを考慮すること。
>
> 例えば、 `not found entity` というエラーログだけが出力されていても何も情報がないため調査が非常に困難になる。
> これを補足するために、次のような情報が併せて出力されていると、トレーサビリティが非常に高くなる。
>
> - いつ (処理が実行された時間)
> - 誰が (ユーザ ID, トレース ID, リクエスト ID)
> - どこで
>   - どの機能、画面からのアクセスで発生したのか
> - 何を
> - なぜ
> - どのように
>
> これらの情報は、リクエストログで自動出力されるものもありはするのだが、技術詳細のパートで出力するのではなく
> しっかりとアプリケーションロジックの一部として考えるべきものであるため、ユースケースで出力するのが望ましい
